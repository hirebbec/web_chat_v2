<!-- templates/chat.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Страница чата</title>
</head>
<body>
    <h1>Чат</h1>
    <p>Вошли как: {{username}}</p>

    <div id="chat-box"></div>

    <form id="message-form">
        <label for="content">Сообщение:</label>
        <input type="text" id="content" name="content" required>
        <input type="submit" value="Отправить">
    </form>

    <script>
        async function fetchMessages() {
            try {
                const response = await fetch('/OpenChat/message');
                const messages = await response.json();

                const chatBox = document.getElementById("chat-box");
                chatBox.innerHTML = "";  // Очистить предыдущие сообщения

                messages.forEach(message => {
                    const messageElement = document.createElement("p");
                    const timestamp = new Date(message.timestamp).toLocaleString();
                    messageElement.textContent = `${timestamp} - ${message.content} (ID: ${message.id}, Sender ID: ${message.sender_id})`;
                    chatBox.appendChild(messageElement);
                });
            } catch (error) {
                console.error('Ошибка при получении сообщений:', error);
            }
        }

        async function sendMessage(event) {
            event.preventDefault();

            const content = document.getElementById("content").value;

            if (content) {
                try {
                    await fetch('/OpenChat/message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content: content,
                            sender_id: {{id}}
                        })
                    });

                    // После отправки сообщения обновим чат
                    fetchMessages();

                    // Очистим поле ввода
                    document.getElementById("content").value = "";
                } catch (error) {
                    console.error('Ошибка при отправке сообщения:', error);
                }
            } else {
                alert("Введите сообщение перед отправкой.");
            }
        }

        // Получаем сообщения при загрузке страницы
        fetchMessages();

        // Устанавливаем таймер для периодического обновления сообщений
        setInterval(fetchMessages, 5000);  // Обновлять каждые 5 секунд

        // Обрабатываем отправку формы
        document.getElementById("message-form").addEventListener("submit", sendMessage);
    </script>
</body>
</html>
